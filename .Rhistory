times = apixaban.data$Time
utimes = sort(unique(times))
N_t = length(times)
N_ut = length(utimes)
D = 2.5 #mg/L
subject.covariates = apixaban.data %>% select(Subject, Sex, Group) %>% distinct()
#0 - Female, 1 = Male
sex = subject.covariates$Sex %>% factor %>% as.numeric
#0 - Control, 1 = Male
group = subject.covariates$Group %>% factor %>% as.numeric()
subject = subject.covariates$Subject %>% factor %>% as.numeric
N_subjects= length(unique(subject))
rstan::stan_rdump(c("t0", "C0", "D", "times", "N_t", "C_hat",'utimes', 'sex','N_subjects'), file="Data/model_2_data.data.R")
input_data <- read_rdump("Data/model_2_data.data.R")
fit = rstan::stan(file = 'Models/model_2.stan',data = input_data)
saveRDS(fit, file = "Data/model_2_fit.rds")
fit = readRDS('Data/model_2_fit.rds')
params = rstan::extract(fit)
#Prepare the data to be passed into stan
C_hat = apixaban.data$Concentration
C0 = array(c(0), dim = 1)
t0 = 0
times = apixaban.data$Time
times = sort(unique(times))
N_t = length(times)
N_ut = length(utimes)
D = 2.5 #mg/L
subject.covariates = apixaban.data %>% select(Subject, Sex, Group) %>% distinct()
#0 - Female, 1 = Male
sex = subject.covariates$Sex %>% factor %>% as.numeric
#0 - Control, 1 = Male
group = subject.covariates$Group %>% factor %>% as.numeric()
subject = subject.covariates$Subject %>% factor %>% as.numeric
N_subjects= length(unique(subject))
times
N_subjects
len(sex)
length(sex)
#Prepare the data to be passed into stan
C_hat = apixaban.data$Concentration
C0 = array(c(0), dim = 1)
t0 = 0
times = apixaban.data$Time
times = sort(unique(times))
N_t = length(times)
N_ut = length(utimes)
D = 2.5 #mg/L
subject.covariates = apixaban.data %>% select(Subject, Sex, Group) %>% distinct()
#0 - Female, 1 = Male
sex = subject.covariates$Sex %>% factor %>% as.numeric
#0 - Control, 1 = Male
group = subject.covariates$Group %>% factor %>% as.numeric()
subject = subject.covariates$Subject %>% factor %>% as.numeric
N_subjects= length(unique(subject))
rstan::stan_rdump(c("t0", "C0", "D", "times", "N_t", "C_hat",'utimes', 'sex','N_subjects'), file="Data/model_2_data.data.R")
input_data <- read_rdump("Data/model_2_data.data.R")
fit = rstan::stan(file = 'Models/model_2.stan',data = input_data)
saveRDS(fit, file = "Data/model_2_fit.rds")
fit = readRDS('Data/model_2_fit.rds')
params = rstan::extract(fit)
fit = rstan::stan(file = 'Models/model_2.stan',data = input_data)
saveRDS(fit, file = "Data/model_2_fit.rds")
fit = readRDS('Data/model_2_fit.rds')
params = rstan::extract(fit)
saveRDS(fit, file = "Data/model_2_fit.rds")
fit = readRDS('Data/model_2_fit.rds')
params = rstan::extract(fit)
fit
#Prepare the data to be passed into stan
C_hat = apixaban.data$Concentration
C0 = array(c(0), dim = 1)
t0 = 0
times = apixaban.data$Time
times = sort(unique(times))
N_t = length(times)
N_ut = length(utimes)
D = 2.5 #mg/L
subject.covariates = apixaban.data %>% select(Subject, Sex, Group) %>% distinct()
#0 - Female, 1 = Male
sex = subject.covariates$Sex %>% factor %>% as.numeric
#0 - Control, 1 = Male
group = subject.covariates$Group %>% factor %>% as.numeric()
subject = subject.covariates$Subject %>% factor %>% as.numeric
N_subjects= length(unique(subject))
rstan::stan_rdump(c("t0", "C0", "D", "times", "N_t", "C_hat", 'sex','N_subjects'), file="Data/model_2_data.data.R")
input_data <- read_rdump("Data/model_2_data.data.R")
#Prepare the data to be passed into stan
C_hat = apixaban.data$Concentration
C0 = array(c(0), dim = 1)
t0 = 0
times = apixaban.data$Time
times = sort(unique(times))
N_t = length(times)
N_ut = length(utimes)
D = 2.5 #mg/L
subject.covariates = apixaban.data %>% select(Subject, Sex, Group) %>% distinct()
#0 - Female, 1 = Male
sex = subject.covariates$Sex %>% factor %>% as.numeric
#0 - Control, 1 = Male
group = subject.covariates$Group %>% factor %>% as.numeric()
subject = subject.covariates$Subject %>% factor %>% as.numeric
N_subjects= length(unique(subject))
rstan::stan_rdump(c("t0", "C0", "D", "times", "N_t", "C_hat", 'sex','N_subjects'), file="Data/model_2_data.data.R")
input_data <- read_rdump("Data/model_2_data.data.R")
input_data
apixaban.data
apixaban.data %>% spread(Time,Concentration)
apixaban.data %>% select(Time,Subject,Concentration) %>% spread(Subject,Time,Concentration)
C_hat
apixaban.data %>%
select(Time,Subject,Concentration)
apixaban.data %>%
select(Time,Subject,Concentration) %>%
spread(Time,Subject)
apixaban.data %>%
select(Time,Subject,Concentration) %>%
spread(Time,Concentration)
apixaban.data %>% select(Time,Subject,Concentration) %>% spread(Subject,Time,Concentration
)
subject.covariates
apixaban.data %>%
select(Time,Subject,Concentration) %>%
spread(Time,Concentration) %>%
as.numeric
apixaban.data %>%
select(Time,Subject,Concentration) %>%
spread(Time,Concentration) %>%
as.numeric()
apixaban.data %>%
select(Time,Subject,Concentration) %>%
spread(Time,Concentration) %>%
matri()
apixaban.data %>%
select(Time,Subject,Concentration) %>%
spread(Time,Concentration) %>%
matrix()
apixaban.data %>%
select(Time,Subject,Concentration) %>%
spread(Time,Concentration) %>%
as.numeric()
# Need to rescale the concentration from ng/ML to mg/L since dose is in mg.
apixaban.data = read_csv('Data/ApixibanExperimentData.csv') %>%
arrange(Subject,Time) %>%
filter(Time>0) %>%
mutate(Concentration_orig = Concentration,
Concentration = 10e-3*Concentration_orig) #resalced from ng/ml to mg/L
#Prepare the data to be passed into stan
C_hat = apixaban.data$Concentration
C0 = array(c(0), dim = 1)
t0 = 0
times = apixaban.data$Time
times = sort(unique(times))
N_t = length(times)
N_ut = length(utimes)
D = 2.5 #mg/L
subject.covariates = apixaban.data %>% select(Subject, Sex, Group) %>% distinct()
#0 - Control, 1 = Male
group = subject.covariates$Group %>% factor %>% as.numeric()
subject = subject.covariates$Subject %>% factor %>% as.numeric
C_hat
dim(C_hat)<-c(N_subjects,N_t)
C_hat
plot(C_hat)
#Prepare the data to be passed into stan
C_hat = apixaban.data$Concentration
C0 = array(c(0), dim = 1)
t0 = 0
times = apixaban.data$Time
times = sort(unique(times))
N_t = length(times)
N_ut = length(utimes)
D = 2.5 #mg/L
subject.covariates = apixaban.data %>% select(Subject, Sex, Group) %>% distinct()
#0 - Female, 1 = Male
sex = subject.covariates$Sex %>% factor %>% as.numeric
#0 - Control, 1 = Male
group = subject.covariates$Group %>% factor %>% as.numeric()
subject = subject.covariates$Subject %>% factor %>% as.numeric
N_subjects= length(unique(subject))
dim(C_hat)<-c(N_subjects,N_t)
rstan::stan_rdump(c("t0", "C0", "D", "times", "N_t", "C_hat", 'sex','N_subjects'), file="Data/model_2_data.data.R")
input_data <- read_rdump("Data/model_2_data.data.R")
fit = rstan::stan(file = 'Models/model_2.stan',data = input_data)
saveRDS(fit, file = "Data/model_2_fit.rds")
fit = readRDS('Data/model_2_fit.rds')
params = rstan::extract(fit)
fit
model.params = params[c('V','k','k_a','sigma', 'beta_k_a')] %>%
as.data.frame()
colnames(model.params) = c('V','k','k[a]','sigma')
model.params %>%
gather(param,sample) %>%
ggplot(aes(sample))+
geom_histogram(fill = 'gray', color = 'black')+
facet_wrap(~param, nrow = 2, scale = 'free', labeller = label_parsed)
fit
fit = rstan::stan(file = 'Models/model_2.stan',data = input_data)
model.params = params[c('beta_k_a')] %>%
as.data.frame()
model.params = params[c('beta_k_a')] %>%
as.data.frame()
colnames(model.params) = c('V','k','k[a]','sigma')
model.params = params[c('beta_k_a')] %>%
as.data.frame()
colnames(model.params) = c('beta_k_a')
model.params %>%
gather(param,sample) %>%
ggplot(aes(sample))+
geom_histogram(fill = 'gray', color = 'black')+
facet_wrap(~param, nrow = 2, scale = 'free', labeller = label_parsed)
knitr::opts_chunk$set(echo =F,
message = F,
warning = F,
out.width = '85%',
fig.align ='center',
dpi = 400 ,
cache = F,
fig.pos = 'h!'
)
library(tidyverse)
library(magrittr)
library(rstan)
options(mc.cores = parallel::detectCores())
theme_set(theme_dark())
# Need to rescale the concentration from ng/ML to mg/L since dose is in mg.
apixaban.data = read_csv('Data/ApixibanExperimentData.csv') %>%
arrange(Subject,Time) %>%
filter(Time>0) %>%
mutate(Concentration_orig = Concentration,
Concentration = 10e-3*Concentration_orig) #resalced from ng/ml to mg/L
#Prepare the data to be passed into stan
C_hat = apixaban.data$Concentration
C0 = array(c(0), dim = 1)
t0 = 0
times = apixaban.data$Time
utimes = sort(unique(times))
N_t = length(times)
N_ut = length(utimes)
D = 2.5 #mg/L
#0 - Female, 1 = Male
sex = apixaban.data$Sex %>% factor %>%  as.numeric() - 1
#0 - Control, 1 = Male
group = apixaban.data$Group %>% factor %>% as.numeric() -1
subject = apixaban.data$Subject %>% factor %>% as.numeric
rstan::stan_rdump(c("t0", "C0", "D", "times", "N_t", "C_hat",'utimes'), file="Data/model_1_data.data.R")
input_data <- read_rdump("Data/model_1_data.data.R")
apixaban.data %>%
ggplot(aes(Time,Concentration, color = Group))+
stat_summary(fun.data = function(x) mean_se(x,1.96), geom = 'errorbar')+
stat_summary(fun.y = mean, geom = 'line')+
stat_summary(fun.y = mean, geom = 'point')+
scale_color_brewer(palette = 'Set1')+
facet_wrap(~Sex)+
theme(aspect.ratio = 1/2)
#Fit model
fit = rstan::stan(file = 'Models/model_1.stan',data = input_data)
saveRDS(fit, file = "Data/model_1_fit.rds")
fit = readRDS('Data/model_1_fit.rds')
params = rstan::extract(fit)
model.params = params[c('V','k','k_a','sigma')] %>%
as.data.frame()
colnames(model.params) = c('V','k','k[a]','sigma')
model.params %>%
gather(param,sample) %>%
ggplot(aes(sample))+
geom_histogram(fill = 'gray', color = 'black')+
facet_wrap(~param, nrow = 2, scale = 'free', labeller = label_parsed)
C = apply(params$C,2, median)
C_interval = apply(params$C,2, function(x) quantile(x,c(0.025,0.975))) %>% t()
preds = data_frame(Concentration = C,
C_L = C_interval[,1],
C_U = C_interval[,2],
Time = utimes)
preds %>%
ggplot()+
geom_line(aes(Time, Concentration), color = 'red')+
geom_ribbon(aes(x = Time, ymin = C_L, ymax = C_U), alpha = 0.25, fill = 'red' )+
stat_summary(data = apixaban.data, aes(Time, Concentration), geom = 'line', fun.data = function(x) mean_se(x,1.96))+
stat_summary(data = apixaban.data, aes(Time, Concentration), geom = 'errorbar', fun.data = function(x) mean_se(x,1.96))+
labs(title = 'Credible Interval')
C = apply(params$C_ppc,2, median)
C_interval = apply(params$C_ppc,2, function(x) quantile(x,c(0.025,0.975))) %>% t()
preds = data_frame(Concentration = C,
C_L = C_interval[,1],
C_U = C_interval[,2],
Time = utimes)
preds %>%
ggplot()+
geom_line(aes(Time, Concentration), color = 'red')+
geom_ribbon(aes(x = Time, ymin = C_L, ymax = C_U), alpha = 0.25, fill = 'red' )+
geom_point(data = apixaban.data, aes(Time, Concentration, alpha = 0.25))+
labs(title = 'Posterior Predictive Interval')
#Prepare the data to be passed into stan
C_hat = apixaban.data$Concentration
C0 = array(c(0), dim = 1)
t0 = 0
times = apixaban.data$Time
times = sort(unique(times))
N_t = length(times)
N_ut = length(utimes)
D = 2.5 #mg/L
subject.covariates = apixaban.data %>% select(Subject, Sex, Group) %>% distinct()
#0 - Female, 1 = Male
sex = subject.covariates$Sex %>% factor %>% as.numeric
#0 - Control, 1 = Male
group = subject.covariates$Group %>% factor %>% as.numeric()
subject = subject.covariates$Subject %>% factor %>% as.numeric
N_subjects= length(unique(subject))
dim(C_hat)<-c(N_subjects,N_t)
rstan::stan_rdump(c("t0", "C0", "D", "times", "N_t", "C_hat", 'sex','N_subjects'), file="Data/model_2_data.data.R")
input_data <- read_rdump("Data/model_2_data.data.R")
fit = rstan::stan(file = 'Models/model_2.stan',data = input_data)
saveRDS(fit, file = "Data/model_2_fit.rds")
fit = readRDS('Data/model_2_fit.rds')
params = rstan::extract(fit)
model.params = params[c('beta_k_a')] %>%
as.data.frame()
colnames(model.params) = c('beta_k_a')
model.params %>%
gather(param,sample) %>%
ggplot(aes(sample))+
geom_histogram(fill = 'gray', color = 'black')+
facet_wrap(~param, nrow = 2, scale = 'free', labeller = label_parsed)
apixaban.data %>%
ggplot(aes(Time,Concentration, color = Group))+
stat_summary(fun.data = function(x) mean_se(x,1.96), geom = 'errorbar')+
stat_summary(fun.y = mean, geom = 'line')+
stat_summary(fun.y = mean, geom = 'point')+
scale_color_brewer(palette = 'Set1')+
facet_wrap(~Sex)+
theme(aspect.ratio = 1/2)
library(tidyverse)
library(magrittr)
library(rstan)
options(mc.cores = parallel::detectCores())
theme_set(theme_minimal())
# Need to rescale the concentration from ng/ML to mg/L since dose is in mg.
apixaban.data = read_csv('Data/ApixibanExperimentData.csv') %>%
arrange(Subject,Time) %>%
filter(Time>0) %>%
mutate(Concentration_orig = Concentration,
Concentration = 10e-3*Concentration_orig) #resalced from ng/ml to mg/L
apixaban.data %>%
ggplot(aes(Time,Concentration, color = Group))+
stat_summary(fun.data = function(x) mean_se(x,1.96), geom = 'errorbar')+
stat_summary(fun.y = mean, geom = 'line')+
stat_summary(fun.y = mean, geom = 'point')+
scale_color_brewer(palette = 'Set1')+
facet_wrap(~Sex)+
theme(aspect.ratio = 1/2)
model.params = params[c('V','k','k_a','sigma')] %>%
as.data.frame()
colnames(model.params) = c('V','k','k[a]','sigma')
model.params %>%
gather(param,sample) %>%
ggplot(aes(sample))+
geom_histogram(fill = 'gray', color = 'black')+
facet_wrap(~param, nrow = 2, scale = 'free', labeller = label_parsed)
fit = readRDS('Data/model_1_fit.rds')
params = rstan::extract(fit)
model.params = params[c('V','k','k_a','sigma')] %>%
as.data.frame()
colnames(model.params) = c('V','k','k[a]','sigma')
model.params %>%
gather(param,sample) %>%
ggplot(aes(sample))+
geom_histogram(fill = 'gray', color = 'black')+
facet_wrap(~param, nrow = 2, scale = 'free', labeller = label_parsed)
C = apply(params$C,2, median)
C_interval = apply(params$C,2, function(x) quantile(x,c(0.025,0.975))) %>% t()
preds = data_frame(Concentration = C,
C_L = C_interval[,1],
C_U = C_interval[,2],
Time = utimes)
preds %>%
ggplot()+
geom_line(aes(Time, Concentration), color = 'red')+
geom_ribbon(aes(x = Time, ymin = C_L, ymax = C_U), alpha = 0.25, fill = 'red' )+
stat_summary(data = apixaban.data, aes(Time, Concentration), geom = 'line', fun.data = function(x) mean_se(x,1.96))+
stat_summary(data = apixaban.data, aes(Time, Concentration), geom = 'errorbar', fun.data = function(x) mean_se(x,1.96))+
labs(title = 'Credible Interval')
C = apply(params$C_ppc,2, median)
C_interval = apply(params$C_ppc,2, function(x) quantile(x,c(0.025,0.975))) %>% t()
preds = data_frame(Concentration = C,
C_L = C_interval[,1],
C_U = C_interval[,2],
Time = utimes)
preds %>%
ggplot()+
geom_line(aes(Time, Concentration), color = 'red')+
geom_ribbon(aes(x = Time, ymin = C_L, ymax = C_U), alpha = 0.25, fill = 'red' )+
geom_point(data = apixaban.data, aes(Time, Concentration, alpha = 0.25))+
labs(title = 'Posterior Predictive Interval')
fit = rstan::stan(file = 'Models/model_2.stan',data = input_data)
fit = rstan::stan(file = 'Models/model_2.stan',data = input_data)
saveRDS(fit, file = "Data/model_2_fit.rds")
fit = readRDS('Data/model_2_fit.rds')
params = rstan::extract(fit)
model.params = params[c('beta_k_a')] %>%
as.data.frame()
colnames(model.params) = c('beta_k_a')
model.params %>%
gather(param,sample) %>%
ggplot(aes(sample))+
geom_histogram(fill = 'gray', color = 'black')+
facet_wrap(~param, nrow = 2, scale = 'free', labeller = label_parsed)
#Prepare the data to be passed into stan
C_hat = apixaban.data$Concentration
C0 = array(c(0), dim = 1)
t0 = 0
times = apixaban.data$Time
times = sort(unique(times))
N_t = length(times)
N_ut = length(utimes)
D = 2.5 #mg/L
subject.covariates = apixaban.data %>% select(Subject, Sex, Group) %>% distinct()
#0 - Female, 1 = Male
sex = subject.covariates$Sex %>% factor %>% as.numeric
#0 - Control, 1 = Male
group = subject.covariates$Group %>% factor %>% as.numeric()
subject = subject.covariates$Subject %>% factor %>% as.numeric
N_subjects= length(unique(subject))
dim(C_hat)<-c(N_subjects,N_t)
rstan::stan_rdump(c("t0", "C0", "D", "times", "N_t", "C_hat", 'sex','N_subjects'), file="Data/model_2_data.data.R")
input_data <- read_rdump("Data/model_2_data.data.R")
sex
#0 - Female, 1 = Male
sex = subject.covariates$Sex %>% factor %>% as.numeric -1
#Prepare the data to be passed into stan
C_hat = apixaban.data$Concentration
C0 = array(c(0), dim = 1)
t0 = 0
times = apixaban.data$Time
times = sort(unique(times))
N_t = length(times)
N_ut = length(utimes)
D = 2.5 #mg/L
subject.covariates = apixaban.data %>% select(Subject, Sex, Group) %>% distinct()
#0 - Female, 1 = Male
sex = subject.covariates$Sex %>% factor %>% as.numeric -1
#0 - Control, 1 = Male
group = subject.covariates$Group %>% factor %>% as.numeric()
subject = subject.covariates$Subject %>% factor %>% as.numeric
N_subjects= length(unique(subject))
dim(C_hat)<-c(N_subjects,N_t)
rstan::stan_rdump(c("t0", "C0", "D", "times", "N_t", "C_hat", 'sex','N_subjects'), file="Data/model_2_data.data.R")
input_data <- read_rdump("Data/model_2_data.data.R")
sex
fit = rstan::stan(file = 'Models/model_2.stan',data = input_data)
saveRDS(fit, file = "Data/model_2_fit.rds")
fit = readRDS('Data/model_2_fit.rds')
params = rstan::extract(fit)
model.params = params[c('beta_k_a')] %>%
as.data.frame()
colnames(model.params) = c('beta_k_a')
model.params %>%
gather(param,sample) %>%
ggplot(aes(sample))+
geom_histogram(fill = 'gray', color = 'black')+
facet_wrap(~param, nrow = 2, scale = 'free', labeller = label_parsed)
install.packages("bayesplot")
library(tidyverse)
library(magrittr)
library(rstan)
library(bayesplot)
options(mc.cores = parallel::detectCores())
theme_set(theme_minimal())
# Need to rescale the concentration from ng/ML to mg/L since dose is in mg.
apixaban.data = read_csv('Data/ApixibanExperimentData.csv') %>%
arrange(Subject,Time) %>%
filter(Time>0) %>%
mutate(Concentration_orig = Concentration,
Concentration = 10e-3*Concentration_orig) #resalced from ng/ml to mg/L
apixaban.data %>%
ggplot(aes(Time,Concentration))+
stat_summary(fun.data = function(x) mean_se(x,1.96), geom = 'errorbar')+
stat_summary(fun.y = mean, geom = 'line')+
stat_summary(fun.y = mean, geom = 'point')+
scale_color_brewer(palette = 'Set1')+
facet_wrap(~Sex)+
theme(aspect.ratio = 1/2)
None
NONE
NA
source('~/Documents/PhD Code/2018-09 Apixiban Bayesian Models/Run Models/Model_2.R', echo=TRUE)
mcmc_scatter(
as.matrix(fit),
pars = c("k", "k_a"),
np = nuts_params(fit),
np_style = scatter_style_np(div_color = "green", div_alpha = 0.8)
)
pix
L = stan_fitter('model_2', input_data = input_data)
L = stan_fitter('model_2', input_data = input_data)
mcmc_areas(as.matrix(fit),
pars = c('k','k_a','beta_V[1]','beta_V[2]'),
prob = 0.8, # 80% intervals
prob_outer = 0.99, # 99%
point_est = "mean")
source('~/Documents/PhD Code/2018-09 Apixiban Bayesian Models/Run Models/Model_2.R', echo=TRUE)
mcmc_areas(as.matrix(fit),
pars = c('k','k_a','beta_V[1]','beta_V[2]'),
prob = 0.8, # 80% intervals
prob_outer = 0.99, # 99%
point_est = "mean")
mcmc_pairs(
as.matrix(fit),
pars = c('k','k_a','beta_V[1]','beta_V[2]'),
np = nuts_params(fit),
np_style = scatter_style_np(div_color = "green", div_alpha = 0.8)
)
source('~/Documents/PhD Code/2018-09 Apixiban Bayesian Models/Run Models/Model_2.R', echo=TRUE)
